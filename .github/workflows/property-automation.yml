# .github/workflows/property-automation.yml
# ë‹¤ì¤‘ ë§¤ë¬¼ ì²˜ë¦¬ìš© ë©”ì¸ ìë™í™” ì›Œí¬í”Œë¡œìš°

name: Property Automation

# Git Push ë° Issue ìƒì„± ê¶Œí•œ ì¶”ê°€
permissions:
  contents: write
  issues: write

on:
  # ë§¤ì¼ ìì • 1ë¶„ì— ìë™ ì‹¤í–‰
  schedule:
    - cron: '1 15 * * *'  # UTC 15:01 = KST 00:01

  # ìˆ˜ë™ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)
  workflow_dispatch:
    inputs:
      property_numbers:
        description: 'ë§¤ë¬¼ë²ˆí˜¸ë“¤ (ì½¤ë§ˆë¡œ êµ¬ë¶„, ì„ íƒì‚¬í•­)'
        required: false
        default: ''
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  check-schedule:
    runs-on: ubuntu-latest
    outputs:
      has_schedule: ${{ steps.check.outputs.has_schedule }}
      property_count: ${{ steps.check.outputs.property_count }}
      properties: ${{ steps.check.outputs.properties }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for scheduled properties
      id: check
      run: |
        if [ -f "data/scheduled_properties.json" ]; then
          echo "has_schedule=true" >> $GITHUB_OUTPUT
          
          # JSONì—ì„œ ë§¤ë¬¼ ì •ë³´ ì¶”ì¶œ
          properties=$(cat data/scheduled_properties.json | jq -r '.properties | join(",")')
          count=$(cat data/scheduled_properties.json | jq -r '.total_count')
          
          echo "properties=${properties}" >> $GITHUB_OUTPUT
          echo "property_count=${count}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ ì˜ˆì•½ëœ ë§¤ë¬¼ ë°œê²¬: ${count}ê°œ"
          echo "ğŸ“Š ë§¤ë¬¼ë²ˆí˜¸: ${properties}"
        else
          echo "has_schedule=false" >> $GITHUB_OUTPUT
          echo "ğŸ“ ì˜ˆì•½ëœ ë§¤ë¬¼ ì—†ìŒ"
        fi

  automation:
    needs: check-schedule
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright/python:v1.55.0-noble
    if: needs.check-schedule.outputs.has_schedule == 'true' || github.event.inputs.property_numbers != ''
    outputs:
      has_failures: ${{ steps.automation_run.outputs.has_failures }}
      failed_properties: ${{ steps.automation_run.outputs.failed_properties }}
      success_count: ${{ steps.automation_run.outputs.success_count }}
      total_count: ${{ steps.automation_run.outputs.total_count }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install playwright==1.55.0
        echo "âœ… Playwright íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ (ë¸Œë¼ìš°ì €ì™€ ì‹œìŠ¤í…œ ì˜ì¡´ì„±ì€ ì»¨í…Œì´ë„ˆì— ì‚¬ì „ ì„¤ì¹˜ë¨)"
    
    - name: Determine property numbers
      id: properties
      run: |
        if [ -n "${{ github.event.inputs.property_numbers }}" ]; then
          # ìˆ˜ë™ ì…ë ¥ëœ ë§¤ë¬¼ë²ˆí˜¸ ì‚¬ìš©
          echo "properties=${{ github.event.inputs.property_numbers }}" >> $GITHUB_OUTPUT
          echo "source=manual" >> $GITHUB_OUTPUT
        else
          # ì˜ˆì•½ íŒŒì¼ì—ì„œ ë§¤ë¬¼ë²ˆí˜¸ ì‚¬ìš©
          echo "properties=${{ needs.check-schedule.outputs.properties }}" >> $GITHUB_OUTPUT
          echo "source=scheduled" >> $GITHUB_OUTPUT
        fi
    
    - name: Run multi-property automation
      id: automation_run
      run: |
        echo "ğŸš€ ë‹¤ì¤‘ ë§¤ë¬¼ ìë™í™” ì‹œì‘..."
        echo "ğŸ“‹ ì²˜ë¦¬í•  ë§¤ë¬¼: ${{ steps.properties.outputs.properties }}"
        echo "ğŸ“Š ë§¤ë¬¼ ê°œìˆ˜: $(echo '${{ steps.properties.outputs.properties }}' | tr ',' '\n' | wc -l)"
        echo "ğŸ”§ í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ${{ github.event.inputs.test_mode || 'false' }}"

        # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (exit code ìº¡ì²˜)
        set +e  # ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ê³„ì† ì‹¤í–‰
        python multi_property_automation.py 2>&1 | tee automation.log
        exit_code=$?
        set -e

        echo "script_exit_code=${exit_code}" >> $GITHUB_OUTPUT

        # ë¡œê·¸ì¸ ì‹¤íŒ¨ ê°ì§€
        if grep -q "âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨ë¡œ ìë™í™” ì¤‘ë‹¨" automation.log; then
          echo "has_login_failure=true" >> $GITHUB_OUTPUT
          echo "::error::ë¡œê·¸ì¸ ì‹¤íŒ¨ë¡œ ìë™í™” ì¤‘ë‹¨ë¨"
          exit 1
        fi

        # ì‹œìŠ¤í…œ ì˜¤ë¥˜ ê°ì§€ (exit codeê°€ 0ì´ ì•„ë‹Œ ê²½ìš°)
        if [ ${exit_code} -ne 0 ]; then
          echo "has_system_error=true" >> $GITHUB_OUTPUT
          echo "::error::Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨ (exit code: ${exit_code})"
          exit 1
        fi

        # ì‹¤íŒ¨í•œ ë§¤ë¬¼ ì¶”ì¶œ
        if grep -q "âŒ ìµœì¢… ì‹¤íŒ¨:" automation.log; then
          failed_properties=$(grep "âŒ ìµœì¢… ì‹¤íŒ¨:" automation.log | sed 's/.*: //')
          echo "failed_properties=${failed_properties}" >> $GITHUB_OUTPUT
          echo "has_failures=true" >> $GITHUB_OUTPUT
        else
          echo "has_failures=false" >> $GITHUB_OUTPUT
        fi

        # ì„±ê³µ/ì‹¤íŒ¨ ì¹´ìš´íŠ¸ ì¶”ì¶œ
        if grep -q "âœ… ìµœì¢… ì„±ê³µ:" automation.log; then
          success_count=$(grep "âœ… ìµœì¢… ì„±ê³µ:" automation.log | sed 's/.*: //;s/\/.*//')
          total_count=$(grep "âœ… ìµœì¢… ì„±ê³µ:" automation.log | sed 's/.*\///;s/ê°œ//')
          echo "success_count=${success_count}" >> $GITHUB_OUTPUT
          echo "total_count=${total_count}" >> $GITHUB_OUTPUT
        fi
      env:
        LOGIN_ID: ${{ secrets.LOGIN_ID }}
        LOGIN_PASSWORD: ${{ secrets.LOGIN_PASSWORD }}
        PROPERTY_NUMBERS: ${{ steps.properties.outputs.properties }}
        TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
        TZ: Asia/Seoul
    
    - name: Delete completed schedule
      if: always() && steps.properties.outputs.source == 'scheduled'
      run: |
        if [ -f "data/scheduled_properties.json" ]; then
          rm data/scheduled_properties.json
          echo "ğŸ—‘ï¸ ì˜ˆì•½ íŒŒì¼ ì‚­ì œ ì™„ë£Œ: scheduled_properties.json"
        else
          echo "ğŸ“ ì‚­ì œí•  ì˜ˆì•½ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
        fi

    - name: Create execution log
      if: always()
      run: |
        timestamp=$(date +"%Y%m%d_%H%M%S")
        mkdir -p results
        
        cat > results/execution_${timestamp}.json << EOF
        {
          "executed_at": "$(date -Iseconds)",
          "properties": "${{ steps.properties.outputs.properties }}",
          "property_count": $(echo '${{ steps.properties.outputs.properties }}' | tr ',' '\n' | wc -l),
          "test_mode": "${{ github.event.inputs.test_mode || 'false' }}",
          "source": "${{ steps.properties.outputs.source }}",
          "status": "completed"
        }
        EOF
        
        echo "ğŸ“ ì‹¤í–‰ ë¡œê·¸ ìƒì„±: results/execution_${timestamp}.json"
    
    - name: Commit results
      if: always()
      run: |
        # Docker ì»¨í…Œì´ë„ˆì—ì„œ Git ë¦¬í¬ì§€í† ë¦¬ ì¸ì‹ (ë™ì  ê²½ë¡œ ì‚¬ìš©)
        git config --global --add safe.directory $GITHUB_WORKSPACE
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"

        # ë³€ê²½ì‚¬í•­ í™•ì¸
        git status

        # Pull ë¨¼ì € ìˆ˜í–‰ (conflict ë°©ì§€)
        git pull --rebase || true

        # ìŠ¤í…Œì´ì§•
        git add results/ data/ || true

        # ì»¤ë°‹ (ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ)
        if git diff --staged --quiet; then
          echo "ğŸ“ ë³€ê²½ì‚¬í•­ ì—†ìŒ - ì»¤ë°‹ ê±´ë„ˆëœ€"
        else
          git commit -m "ğŸ¤– ìë™í™” ì‹¤í–‰ ì™„ë£Œ $(date +"%Y-%m-%d %H:%M:%S")"
          echo "âœ… ì»¤ë°‹ ì™„ë£Œ"

          # Push (ìµœëŒ€ 3íšŒ ì¬ì‹œë„)
          for i in 1 2 3; do
            if git push; then
              echo "âœ… Push ì„±ê³µ (ì‹œë„ $i)"
              break
            else
              echo "âš ï¸ Push ì‹¤íŒ¨ (ì‹œë„ $i) - ì¬ì‹œë„..."
              sleep 2
              git pull --rebase || true
            fi
          done
        fi
    
    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: automation-screenshots-${{ github.run_number }}
        path: "*.png"
        retention-days: 7
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: automation-logs-${{ github.run_number }}
        path: |
          *.log
          results/
        retention-days: 30

    - name: Check automation result and notify
      if: always()
      run: |
        echo "ğŸ“Š ìë™í™” ì‹¤í–‰ ê²°ê³¼:"

        # ë¹ˆ ê°’ ì²˜ë¦¬
        total="${{ steps.automation_run.outputs.total_count }}"
        success="${{ steps.automation_run.outputs.success_count }}"

        if [ -z "$total" ]; then total=0; fi
        if [ -z "$success" ]; then success=0; fi

        echo "- ì „ì²´: ${total}ê°œ"
        echo "- ì„±ê³µ: ${success}ê°œ"

        # ì‹¤íŒ¨ ê°œìˆ˜ ê³„ì‚°
        failed=$((total - success))
        echo "- ì‹¤íŒ¨: ${failed}ê°œ"

        # ì‹¤íŒ¨ ê°ì§€: 1ê°œë¼ë„ ì‹¤íŒ¨í•˜ë©´ ê²½ê³  ì¶œë ¥ (automation jobì€ ì´ë¯¸ ì‹¤íŒ¨ ì²˜ë¦¬ë¨)
        if [ "${{ steps.automation_run.outputs.has_failures }}" = "true" ]; then
          echo ""
          echo "::warning::âš ï¸ ì¼ë¶€ ë§¤ë¬¼ ì²˜ë¦¬ ì‹¤íŒ¨"
          echo "::warning::ì‹¤íŒ¨í•œ ë§¤ë¬¼ ë²ˆí˜¸: ${{ steps.automation_run.outputs.failed_properties }}"
          echo "::warning::ì²˜ë¦¬ ê²°ê³¼: ${success}/${total}ê°œ ì„±ê³µ"
        elif [ ${total} -gt 0 ] && [ ${success} -eq ${total} ]; then
          echo "âœ… ëª¨ë“  ë§¤ë¬¼ ì²˜ë¦¬ ì„±ê³µ!"
        fi

    - name: Calculate failure count
      id: calc_failures
      if: always()
      run: |
        total=${{ steps.automation_run.outputs.total_count }}
        success=${{ steps.automation_run.outputs.success_count }}

        # ë¹ˆ ê°’ ì²˜ë¦¬
        if [ -z "$total" ]; then total=0; fi
        if [ -z "$success" ]; then success=0; fi

        failed=$((total - success))
        echo "failed_count=${failed}" >> $GITHUB_OUTPUT
        echo "ì‹¤íŒ¨ ê°œìˆ˜: ${failed}ê°œ"

  no-schedule:
    needs: check-schedule
    runs-on: ubuntu-latest
    if: needs.check-schedule.outputs.has_schedule == 'false' && github.event.inputs.property_numbers == ''

    steps:
    - name: No automation needed
      run: |
        echo "â„¹ï¸ ì‹¤í–‰í•  ìë™í™” ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤."
        echo ""
        echo "ğŸ“‹ ì˜ˆì•½ëœ ë§¤ë¬¼: ì—†ìŒ"
        echo "ğŸ“ ìˆ˜ë™ ì…ë ¥: ì—†ìŒ"
        echo ""
        echo "ğŸ’¡ ë§¤ë¬¼ì„ ì˜ˆì•½í•˜ë ¤ë©´:"
        echo "1. PC GUIì—ì„œ ë§¤ë¬¼ ì„ íƒ"
        echo "2. GitHubì— scheduled_properties.json ì—…ë¡œë“œ"
        echo "3. ë‹¤ìŒ ìì •ì— ìë™ ì‹¤í–‰ë¨"

  # ëª¨ë“  ì˜¤ë¥˜ ê°ì§€ ë° ì•Œë¦¼ (ë§¤ë¬¼ ì‹¤íŒ¨ + ì‹œìŠ¤í…œ ì˜¤ë¥˜)
  final-check:
    needs: [check-schedule, automation]
    runs-on: ubuntu-latest
    if: always() && (needs.check-schedule.outputs.has_schedule == 'true' || github.event.inputs.property_numbers != '')

    steps:
    - name: Check workflow status
      id: workflow_status
      run: |
        echo "ğŸ“Š ìµœì¢… ìƒíƒœ í™•ì¸"
        echo ""
        echo "ğŸ” Automation Job ìƒíƒœ: ${{ needs.automation.result }}"
        echo ""

        # automation job ì‹¤íŒ¨ í™•ì¸ (ë¡œê·¸ì¸ ì‹¤íŒ¨, ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë“±)
        if [ "${{ needs.automation.result }}" == "failure" ]; then
          echo "::error::âŒ ìë™í™” ì‹¤í–‰ ì‹¤íŒ¨!"
          echo ""

          # ë¡œê·¸ì—ì„œ ì‹¤íŒ¨ ì›ì¸ íŒŒì•…
          echo "ğŸ“‹ ê°ì§€ëœ ì˜¤ë¥˜ ìœ í˜•:"

          # ë¡œê·¸ì¸ ì‹¤íŒ¨ ì—¬ë¶€ í™•ì¸ (automation jobì—ì„œ ì„¤ì •)
          echo "  - ë¡œê·¸ì¸ ì‹¤íŒ¨ ì—¬ë¶€: í™•ì¸ í•„ìš”"
          echo "  - ì‹œìŠ¤í…œ ì˜¤ë¥˜ ì—¬ë¶€: í™•ì¸ í•„ìš”"
          echo ""

          echo "ğŸ” ìƒì„¸ ë¡œê·¸: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "has_system_error=true" >> $GITHUB_OUTPUT

          # failure_reason ì¶”ì¶œ ì‹œë„
          echo "failure_reason=ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë˜ëŠ” ë¡œê·¸ì¸ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
          exit 1

        elif [ "${{ needs.automation.result }}" == "cancelled" ]; then
          echo "::error::âš ï¸ ìë™í™” ì‹¤í–‰ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "has_system_error=true" >> $GITHUB_OUTPUT
          echo "failure_reason=ì‹¤í–‰ ì·¨ì†Œë¨" >> $GITHUB_OUTPUT
          exit 1

        elif [ "${{ needs.automation.result }}" == "skipped" ]; then
          echo "::warning::â­ï¸ ìë™í™” ì‹¤í–‰ì´ ê±´ë„ˆë›°ì–´ì¡ŒìŠµë‹ˆë‹¤."
          echo "failure_reason=ì‹¤í–‰ ê±´ë„ˆëœ€" >> $GITHUB_OUTPUT

        else
          # automation job ì„±ê³µ ì‹œì—ë„ ë§¤ë¬¼ ì‹¤íŒ¨ ì²´í¬
          if [ "${{ needs.automation.outputs.has_failures }}" == "true" ]; then
            echo "has_property_failures=true" >> $GITHUB_OUTPUT
            echo "::warning::âš ï¸ ì¼ë¶€ ë§¤ë¬¼ ì²˜ë¦¬ ì‹¤íŒ¨ (ìë™í™”ëŠ” ì •ìƒ ì‹¤í–‰ë¨)"
          else
            echo "âœ… ìë™í™” ì •ìƒ ì™„ë£Œ (ëª¨ë“  ë§¤ë¬¼ ì²˜ë¦¬ ì„±ê³µ)"
          fi
        fi

    - name: Download automation logs for failure details
      if: always() && steps.workflow_status.outputs.has_property_failures == 'true'
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: automation-logs-${{ github.run_number }}
        path: ./logs

    - name: Extract failure stage details
      if: always() && steps.workflow_status.outputs.has_property_failures == 'true'
      id: extract_stages
      continue-on-error: true
      run: |
        if [ -f "./logs/automation.log" ]; then
          # ì‹¤íŒ¨ ë‹¨ê³„ë³„ ìƒì„¸ ì •ë³´ ì¶”ì¶œ
          stage_details=""

          # ë…¸ì¶œì¢…ë£Œ ì‹¤íŒ¨
          if grep -q "ğŸ“‹ ë…¸ì¶œì¢…ë£Œ ì‹¤íŒ¨:" ./logs/automation.log; then
            exposure_failed=$(grep "ğŸ“‹ ë…¸ì¶œì¢…ë£Œ ì‹¤íŒ¨:" ./logs/automation.log | tail -1 | sed 's/.*ğŸ“‹ ë…¸ì¶œì¢…ë£Œ ì‹¤íŒ¨: //')
            stage_details="${stage_details}\nğŸ“‹ ë…¸ì¶œì¢…ë£Œ ì‹¤íŒ¨: ${exposure_failed}"
          fi

          # ê´‘ê³  ì €ì¥ë¨ (ê²°ì œ ì•ˆë¨)
          if grep -q "ğŸ“ ê´‘ê³  ì €ì¥ë¨(ê²°ì œì•ˆë¨):" ./logs/automation.log; then
            saved_failed=$(grep "ğŸ“ ê´‘ê³  ì €ì¥ë¨(ê²°ì œì•ˆë¨):" ./logs/automation.log | tail -1 | sed 's/.*ğŸ“ ê´‘ê³  ì €ì¥ë¨(ê²°ì œì•ˆë¨): //')
            stage_details="${stage_details}\nğŸ“ ê´‘ê³  ì €ì¥ë¨(ê²°ì œì•ˆë¨): ${saved_failed}"
          fi

          # ì¶©ì „ê¸ˆ ë¶€ì¡±
          if grep -q "ğŸ’° ì¶©ì „ê¸ˆ ë¶€ì¡±:" ./logs/automation.log; then
            insufficient_failed=$(grep "ğŸ’° ì¶©ì „ê¸ˆ ë¶€ì¡±:" ./logs/automation.log | tail -1 | sed 's/.*ğŸ’° ì¶©ì „ê¸ˆ ë¶€ì¡±: //')
            stage_details="${stage_details}\nğŸ’° ì¶©ì „ê¸ˆ ë¶€ì¡±: ${insufficient_failed}"
          fi

          # ê²°ì œ ì‹¤íŒ¨
          if grep -q "ğŸ’³ ê²°ì œ ì‹¤íŒ¨:" ./logs/automation.log; then
            payment_failed=$(grep "ğŸ’³ ê²°ì œ ì‹¤íŒ¨:" ./logs/automation.log | tail -1 | sed 's/.*ğŸ’³ ê²°ì œ ì‹¤íŒ¨: //')
            stage_details="${stage_details}\nğŸ’³ ê²°ì œ ì‹¤íŒ¨: ${payment_failed}"
          fi

          # ë©€í‹°ë¼ì¸ ì¶œë ¥ì„ ìœ„í•œ ì²˜ë¦¬
          echo "stage_details<<EOF" >> $GITHUB_OUTPUT
          echo -e "${stage_details}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "stage_details=ë¡œê·¸ íŒŒì¼ ì—†ìŒ" >> $GITHUB_OUTPUT
        fi

    - name: Create issue on property failures
      if: always() && steps.workflow_status.outputs.has_property_failures == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const repository = '${{ github.repository }}';
          const runId = '${{ github.run_id }}';
          const eventName = '${{ github.event_name }}';
          const workflow = '${{ github.workflow }}';

          const failedProperties = '${{ needs.automation.outputs.failed_properties }}' || 'ì—†ìŒ';
          const successCount = '${{ needs.automation.outputs.success_count }}' || '0';
          const totalCount = '${{ needs.automation.outputs.total_count }}' || '0';
          const failedCount = totalCount - successCount;
          const stageDetails = `${{ steps.extract_stages.outputs.stage_details }}` || 'ìƒì„¸ ì •ë³´ ì—†ìŒ';

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ë§¤ë¬¼ ì²˜ë¦¬ ì‹¤íŒ¨ - ' + new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'}),
            labels: ['automation-error', 'property-failure'],
            body: "**ì²˜ë¦¬ ê²°ê³¼:** " + failedCount + "/" + totalCount + "ê°œ ì‹¤íŒ¨\n\n" +
              "**ì‹¤íŒ¨ ë§¤ë¬¼ ë²ˆí˜¸:** " + failedProperties + "\n\n" +
              "**ì‹¤íŒ¨ ë‹¨ê³„ë³„ ìƒì„¸:**\n" + stageDetails
          })
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download automation logs
      if: failure() && steps.workflow_status.outputs.has_system_error == 'true'
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        name: automation-logs-${{ github.run_number }}
        path: ./logs

    - name: Extract failure reason from logs
      if: failure() && steps.workflow_status.outputs.has_system_error == 'true'
      id: extract_reason
      continue-on-error: true
      run: |
        if [ -f "./logs/automation.log" ]; then
          # ë¡œê·¸ì¸ ì‹¤íŒ¨ í™•ì¸
          if grep -q "âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨ë¡œ ìë™í™” ì¤‘ë‹¨" ./logs/automation.log; then
            echo "failure_type=ğŸ” ë¡œê·¸ì¸ ì‹¤íŒ¨" >> $GITHUB_OUTPUT
            login_url=$(grep "ë¡œê·¸ì¸ í›„ URL:" ./logs/automation.log | tail -1 | sed 's/ğŸ”— ë¡œê·¸ì¸ í›„ URL: //' || echo "URL í™•ì¸ ë¶ˆê°€")
            echo "failure_details=${login_url}" >> $GITHUB_OUTPUT
          # ë§¤ë¬¼ë²ˆí˜¸ ì—†ìŒ
          elif grep -q "âŒ ì²˜ë¦¬í•  ë§¤ë¬¼ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤" ./logs/automation.log; then
            echo "failure_type=ğŸ“‹ ë§¤ë¬¼ë²ˆí˜¸ ì—†ìŒ" >> $GITHUB_OUTPUT
            echo "failure_details=í™˜ê²½ë³€ìˆ˜ì— ë§¤ë¬¼ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ" >> $GITHUB_OUTPUT
          # ê¸°íƒ€ Python ì˜¤ë¥˜
          elif grep -q "âŒ ìë™í™” ì‹¤í–‰ ì‹¤íŒ¨:" ./logs/automation.log; then
            error_msg=$(grep "âŒ ìë™í™” ì‹¤í–‰ ì‹¤íŒ¨:" ./logs/automation.log | tail -1 | sed 's/âŒ ìë™í™” ì‹¤í–‰ ì‹¤íŒ¨: //')
            echo "failure_type=âš ï¸ Python ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜" >> $GITHUB_OUTPUT
            echo "failure_details=${error_msg}" >> $GITHUB_OUTPUT
          else
            echo "failure_type=â“ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜" >> $GITHUB_OUTPUT
            echo "failure_details=ë¡œê·¸ì—ì„œ ì˜¤ë¥˜ ì›ì¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ" >> $GITHUB_OUTPUT
          fi
        else
          echo "failure_type=ğŸ“ ë¡œê·¸ íŒŒì¼ ì—†ìŒ" >> $GITHUB_OUTPUT
          echo "failure_details=automation.log íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ" >> $GITHUB_OUTPUT
        fi

    - name: Create issue on system error
      if: failure() && steps.workflow_status.outputs.has_system_error == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const failureType = '${{ steps.extract_reason.outputs.failure_type }}' || 'â“ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
          const failureDetails = '${{ steps.extract_reason.outputs.failure_details }}' || 'ì—†ìŒ';

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ìë™í™” ì‹¤íŒ¨ - ' + new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'}),
            labels: ['automation-error', 'system-error'],
            body: failureType + "\n\n**ì‹¤íŒ¨ ì›ì¸:** " + failureDetails
          })
        github-token: ${{ secrets.GITHUB_TOKEN }}
