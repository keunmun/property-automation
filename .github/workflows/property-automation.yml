# .github/workflows/property-automation.yml
# ë‹¤ì¤‘ ë§¤ë¬¼ ì²˜ë¦¬ìš© ë©”ì¸ ìë™í™” ì›Œí¬í”Œë¡œìš°

name: Property Automation

# Git Push ê¶Œí•œ ì¶”ê°€
permissions:
  contents: write

on:
  # ë§¤ì¼ ìì • 1ë¶„ì— ìë™ ì‹¤í–‰
  schedule:
    - cron: '1 15 * * *'  # UTC 15:01 = KST 00:01

  # ìˆ˜ë™ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)
  workflow_dispatch:
    inputs:
      property_numbers:
        description: 'ë§¤ë¬¼ë²ˆí˜¸ë“¤ (ì½¤ë§ˆë¡œ êµ¬ë¶„, ì„ íƒì‚¬í•­)'
        required: false
        default: ''
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  check-schedule:
    runs-on: ubuntu-latest
    outputs:
      has_schedule: ${{ steps.check.outputs.has_schedule }}
      property_count: ${{ steps.check.outputs.property_count }}
      properties: ${{ steps.check.outputs.properties }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for scheduled properties
      id: check
      run: |
        if [ -f "data/scheduled_properties.json" ]; then
          echo "has_schedule=true" >> $GITHUB_OUTPUT
          
          # JSONì—ì„œ ë§¤ë¬¼ ì •ë³´ ì¶”ì¶œ
          properties=$(cat data/scheduled_properties.json | jq -r '.properties | join(",")')
          count=$(cat data/scheduled_properties.json | jq -r '.total_count')
          
          echo "properties=${properties}" >> $GITHUB_OUTPUT
          echo "property_count=${count}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ ì˜ˆì•½ëœ ë§¤ë¬¼ ë°œê²¬: ${count}ê°œ"
          echo "ğŸ“Š ë§¤ë¬¼ë²ˆí˜¸: ${properties}"
        else
          echo "has_schedule=false" >> $GITHUB_OUTPUT
          echo "ğŸ“ ì˜ˆì•½ëœ ë§¤ë¬¼ ì—†ìŒ"
        fi

  automation:
    needs: check-schedule
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright/python:v1.55.0-noble
    if: needs.check-schedule.outputs.has_schedule == 'true' || github.event.inputs.property_numbers != ''
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install playwright==1.55.0
        echo "âœ… Playwright íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ (ë¸Œë¼ìš°ì €ì™€ ì‹œìŠ¤í…œ ì˜ì¡´ì„±ì€ ì»¨í…Œì´ë„ˆì— ì‚¬ì „ ì„¤ì¹˜ë¨)"
    
    - name: Determine property numbers
      id: properties
      run: |
        if [ -n "${{ github.event.inputs.property_numbers }}" ]; then
          # ìˆ˜ë™ ì…ë ¥ëœ ë§¤ë¬¼ë²ˆí˜¸ ì‚¬ìš©
          echo "properties=${{ github.event.inputs.property_numbers }}" >> $GITHUB_OUTPUT
          echo "source=manual" >> $GITHUB_OUTPUT
        else
          # ì˜ˆì•½ íŒŒì¼ì—ì„œ ë§¤ë¬¼ë²ˆí˜¸ ì‚¬ìš©
          echo "properties=${{ needs.check-schedule.outputs.properties }}" >> $GITHUB_OUTPUT
          echo "source=scheduled" >> $GITHUB_OUTPUT
        fi
    
    - name: Run multi-property automation
      id: automation_run
      continue-on-error: true
      run: |
        echo "ğŸš€ ë‹¤ì¤‘ ë§¤ë¬¼ ìë™í™” ì‹œì‘..."
        echo "ğŸ“‹ ì²˜ë¦¬í•  ë§¤ë¬¼: ${{ steps.properties.outputs.properties }}"
        echo "ğŸ“Š ë§¤ë¬¼ ê°œìˆ˜: $(echo '${{ steps.properties.outputs.properties }}' | tr ',' '\n' | wc -l)"
        echo "ğŸ”§ í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ${{ github.event.inputs.test_mode || 'false' }}"

        python multi_property_automation.py 2>&1 | tee automation.log

        # ì‹¤íŒ¨í•œ ë§¤ë¬¼ ì¶”ì¶œ
        if grep -q "âŒ ìµœì¢… ì‹¤íŒ¨:" automation.log; then
          failed_properties=$(grep "âŒ ìµœì¢… ì‹¤íŒ¨:" automation.log | sed 's/.*: //')
          echo "failed_properties=${failed_properties}" >> $GITHUB_OUTPUT
          echo "has_failures=true" >> $GITHUB_OUTPUT
        else
          echo "has_failures=false" >> $GITHUB_OUTPUT
        fi

        # ì„±ê³µ/ì‹¤íŒ¨ ì¹´ìš´íŠ¸ ì¶”ì¶œ
        if grep -q "âœ… ìµœì¢… ì„±ê³µ:" automation.log; then
          success_count=$(grep "âœ… ìµœì¢… ì„±ê³µ:" automation.log | sed 's/.*: //;s/\/.*//')
          total_count=$(grep "âœ… ìµœì¢… ì„±ê³µ:" automation.log | sed 's/.*\///;s/ê°œ//')
          echo "success_count=${success_count}" >> $GITHUB_OUTPUT
          echo "total_count=${total_count}" >> $GITHUB_OUTPUT
        fi
      env:
        LOGIN_ID: ${{ secrets.LOGIN_ID }}
        LOGIN_PASSWORD: ${{ secrets.LOGIN_PASSWORD }}
        PROPERTY_NUMBERS: ${{ steps.properties.outputs.properties }}
        TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
        TZ: Asia/Seoul
    
    - name: Delete completed schedule
      if: always() && steps.properties.outputs.source == 'scheduled'
      run: |
        if [ -f "data/scheduled_properties.json" ]; then
          rm data/scheduled_properties.json
          echo "ğŸ—‘ï¸ ì˜ˆì•½ íŒŒì¼ ì‚­ì œ ì™„ë£Œ: scheduled_properties.json"
        else
          echo "ğŸ“ ì‚­ì œí•  ì˜ˆì•½ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
        fi

    - name: Create execution log
      if: always()
      run: |
        timestamp=$(date +"%Y%m%d_%H%M%S")
        mkdir -p results
        
        cat > results/execution_${timestamp}.json << EOF
        {
          "executed_at": "$(date -Iseconds)",
          "properties": "${{ steps.properties.outputs.properties }}",
          "property_count": $(echo '${{ steps.properties.outputs.properties }}' | tr ',' '\n' | wc -l),
          "test_mode": "${{ github.event.inputs.test_mode || 'false' }}",
          "source": "${{ steps.properties.outputs.source }}",
          "status": "completed"
        }
        EOF
        
        echo "ğŸ“ ì‹¤í–‰ ë¡œê·¸ ìƒì„±: results/execution_${timestamp}.json"
    
    - name: Commit results
      if: always()
      run: |
        # Docker ì»¨í…Œì´ë„ˆì—ì„œ Git ë¦¬í¬ì§€í† ë¦¬ ì¸ì‹ (ë™ì  ê²½ë¡œ ì‚¬ìš©)
        git config --global --add safe.directory $GITHUB_WORKSPACE
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"

        # ë³€ê²½ì‚¬í•­ í™•ì¸
        git status

        # Pull ë¨¼ì € ìˆ˜í–‰ (conflict ë°©ì§€)
        git pull --rebase || true

        # ìŠ¤í…Œì´ì§•
        git add results/ data/ || true

        # ì»¤ë°‹ (ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ)
        if git diff --staged --quiet; then
          echo "ğŸ“ ë³€ê²½ì‚¬í•­ ì—†ìŒ - ì»¤ë°‹ ê±´ë„ˆëœ€"
        else
          git commit -m "ğŸ¤– ìë™í™” ì‹¤í–‰ ì™„ë£Œ $(date +"%Y-%m-%d %H:%M:%S")"
          echo "âœ… ì»¤ë°‹ ì™„ë£Œ"

          # Push (ìµœëŒ€ 3íšŒ ì¬ì‹œë„)
          for i in 1 2 3; do
            if git push; then
              echo "âœ… Push ì„±ê³µ (ì‹œë„ $i)"
              break
            else
              echo "âš ï¸ Push ì‹¤íŒ¨ (ì‹œë„ $i) - ì¬ì‹œë„..."
              sleep 2
              git pull --rebase || true
            fi
          done
        fi
    
    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: automation-screenshots-${{ github.run_number }}
        path: "*.png"
        retention-days: 7
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: automation-logs-${{ github.run_number }}
        path: |
          *.log
          results/
        retention-days: 30

    - name: Check automation result and notify
      if: always()
      run: |
        echo "ğŸ“Š ìë™í™” ì‹¤í–‰ ê²°ê³¼:"
        echo "- ì „ì²´: ${{ steps.automation_run.outputs.total_count }}ê°œ"
        echo "- ì„±ê³µ: ${{ steps.automation_run.outputs.success_count }}ê°œ"

        # ì‹¤íŒ¨ ê°œìˆ˜ ê³„ì‚°
        total=${{ steps.automation_run.outputs.total_count }}
        success=${{ steps.automation_run.outputs.success_count }}
        failed=$((total - success))
        echo "- ì‹¤íŒ¨: ${failed}ê°œ"

        # ì‹¤íŒ¨ ê°ì§€: 1ê°œë¼ë„ ì‹¤íŒ¨í•˜ë©´ has_failures=trueë¡œ ì„¤ì •
        if [ "${{ steps.automation_run.outputs.has_failures }}" == "true" ] || [ "${{ steps.automation_run.outputs.success_count }}" != "${{ steps.automation_run.outputs.total_count }}" ]; then
          echo ""
          echo "::error::âŒ ë§¤ë¬¼ ìë™í™” ì‹¤íŒ¨ ë°œìƒ!"
          echo "::error::ì‹¤íŒ¨í•œ ë§¤ë¬¼ ë²ˆí˜¸: ${{ steps.automation_run.outputs.failed_properties }}"
          echo "::error::ì²˜ë¦¬ ê²°ê³¼: ${{ steps.automation_run.outputs.success_count }}/${{ steps.automation_run.outputs.total_count }}ê°œ ì„±ê³µ"
          echo ""
          echo "ğŸ“‹ ê°€ëŠ¥í•œ ì‹¤íŒ¨ ì‚¬ìœ :"
          echo "  - ë§¤ë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ (ì‚­ì œë˜ì—ˆê±°ë‚˜ ì´ë¯¸ ì²˜ë¦¬ë¨)"
          echo "  - ë¡œì¼“ë“±ë¡ ìƒí’ˆì´ ì•„ë‹˜"
          echo "  - ì²´í¬ë°•ìŠ¤ í´ë¦­ ì‹¤íŒ¨"
          echo "  - ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨"
          echo "  - ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” íƒ€ì„ì•„ì›ƒ"
          exit 1
        else
          echo "âœ… ëª¨ë“  ë§¤ë¬¼ ì²˜ë¦¬ ì„±ê³µ!"
        fi

    - name: Calculate failure count
      id: calc_failures
      if: always()
      run: |
        total=${{ steps.automation_run.outputs.total_count }}
        success=${{ steps.automation_run.outputs.success_count }}

        # ë¹ˆ ê°’ ì²˜ë¦¬
        if [ -z "$total" ]; then total=0; fi
        if [ -z "$success" ]; then success=0; fi

        failed=$((total - success))
        echo "failed_count=${failed}" >> $GITHUB_OUTPUT
        echo "ì‹¤íŒ¨ ê°œìˆ˜: ${failed}ê°œ"

  no-schedule:
    needs: check-schedule
    runs-on: ubuntu-latest
    if: needs.check-schedule.outputs.has_schedule == 'false' && github.event.inputs.property_numbers == ''

    steps:
    - name: No automation needed
      run: |
        echo "â„¹ï¸ ì‹¤í–‰í•  ìë™í™” ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤."
        echo ""
        echo "ğŸ“‹ ì˜ˆì•½ëœ ë§¤ë¬¼: ì—†ìŒ"
        echo "ğŸ“ ìˆ˜ë™ ì…ë ¥: ì—†ìŒ"
        echo ""
        echo "ğŸ’¡ ë§¤ë¬¼ì„ ì˜ˆì•½í•˜ë ¤ë©´:"
        echo "1. PC GUIì—ì„œ ë§¤ë¬¼ ì„ íƒ"
        echo "2. GitHubì— scheduled_properties.json ì—…ë¡œë“œ"
        echo "3. ë‹¤ìŒ ìì •ì— ìë™ ì‹¤í–‰ë¨"

  # ëª¨ë“  ì˜¤ë¥˜ ê°ì§€ ë° ì•Œë¦¼ (ì»¨í…Œì´ë„ˆ ì˜¤ë¥˜ í¬í•¨)
  final-check:
    needs: [check-schedule, automation]
    runs-on: ubuntu-latest
    if: always() && (needs.check-schedule.outputs.has_schedule == 'true' || github.event.inputs.property_numbers != '')

    steps:
    - name: Check workflow status
      id: workflow_status
      run: |
        echo "ğŸ“Š ìµœì¢… ìƒíƒœ í™•ì¸"

        # automation job ê²°ê³¼ í™•ì¸
        if [ "${{ needs.automation.result }}" == "failure" ]; then
          echo "::error::âŒ ìë™í™” ì‹¤í–‰ ì‹¤íŒ¨!"
          echo "::error::ì»¨í…Œì´ë„ˆ ì˜¤ë¥˜, ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜ ë˜ëŠ” ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
          echo ""
          echo "ğŸ“‹ ê°€ëŠ¥í•œ ì˜¤ë¥˜ ì›ì¸:"
          echo "  - Docker ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨ (ì´ë¯¸ì§€ ì˜¤ë¥˜)"
          echo "  - Playwright ì„¤ì¹˜ ì˜¤ë¥˜"
          echo "  - Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜"
          echo "  - ë„¤íŠ¸ì›Œí¬ íƒ€ì„ì•„ì›ƒ"
          echo ""
          echo "ğŸ” ìƒì„¸ ë¡œê·¸: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "has_system_error=true" >> $GITHUB_OUTPUT
          exit 1
        elif [ "${{ needs.automation.result }}" == "cancelled" ]; then
          echo "::error::âš ï¸ ìë™í™” ì‹¤í–‰ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "has_system_error=true" >> $GITHUB_OUTPUT
          exit 1
        elif [ "${{ needs.automation.result }}" == "skipped" ]; then
          echo "::warning::â­ï¸ ìë™í™” ì‹¤í–‰ì´ ê±´ë„ˆë›°ì–´ì¡ŒìŠµë‹ˆë‹¤."
        else
          echo "âœ… ìë™í™” ì •ìƒ ì™„ë£Œ"
        fi

    - name: Send system error email notification
      if: failure() && steps.workflow_status.outputs.has_system_error == 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_APP_PASSWORD }}
        subject: "ğŸš¨ ë„¤ì´ë²„ë¶€ë™ì‚° ìë™í™” ì‹œìŠ¤í…œ ì˜¤ë¥˜ ë°œìƒ!"
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          ğŸš¨ ë„¤ì´ë²„ë¶€ë™ì‚° ìë™í™” ì‹œìŠ¤í…œ ì˜¤ë¥˜

          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          âš ï¸ ì˜¤ë¥˜ ìœ í˜•
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ìë™í™” Job ì‹¤í–‰ ì‹¤íŒ¨: ${{ needs.automation.result }}

          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸ“‹ ê°€ëŠ¥í•œ ì‹œìŠ¤í…œ ì˜¤ë¥˜ ì›ì¸
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          â€¢ Docker ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨
          â€¢ Playwright ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜
          â€¢ Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì˜¤ë¥˜
          â€¢ ë„¤íŠ¸ì›Œí¬ ì—°ê²° íƒ€ì„ì•„ì›ƒ
          â€¢ GitHub Actions ì‹œìŠ¤í…œ ì¥ì• 
          â€¢ Python ìŠ¤í¬ë¦½íŠ¸ í¬ë˜ì‹œ

          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ğŸ” ìƒì„¸ ë¡œê·¸ í™•ì¸ (í•„ìˆ˜)
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ì‹¤í–‰ ì‹œê°„: ${{ github.event.repository.updated_at }}
          íŠ¸ë¦¬ê±°: ${{ github.event_name }}
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
